(function ($) {
    'use strict';
    $(document).ready(function () {
        var unitsConversionParameter = 10.76391;

        $('.tips, .help_tip').tipTip({
            'attribute': 'data-tip',
            'fadeIn': 50,
            'fadeOut': 50,
            'delay': 200
        });

        //Manage the visibility of the taxonomy widgets which are normally shown on the right in admin panel (when adding properties)
        var residential_type_box_taxonomy ='#tagsdiv-property-residential-type';
        var residential_type_box_taxonomy_select = residential_type_box_taxonomy + ' select[name="tax_input[property-residential-type][]"]';
        var residential_type_box_post_select  ='#real_estate_property_residential_type select[name="real_estate_property_residential_type"]';
        $(residential_type_box_taxonomy).css("display", "none");
        $(residential_type_box_taxonomy_select).val($(residential_type_box_post_select).val());
        $(residential_type_box_post_select).change(function(){
            $(residential_type_box_taxonomy_select).val($(this).val());
        });

        var resid_furnished_type_box_taxonomy ='#tagsdiv-property-resid-furnished-type';
        var resid_furnished_type_box_taxonomy_select = resid_furnished_type_box_taxonomy + ' select[name="tax_input[property-resid-furnished-type][]"]';
        var resid_furnished_type_box_post_select  ='#real_estate_property_resid_furnished_type select[name="real_estate_property_resid_furnished_type"]';
        $(resid_furnished_type_box_taxonomy).css("display", "none");
        $(resid_furnished_type_box_taxonomy_select).val($(resid_furnished_type_box_post_select).val());
        $(resid_furnished_type_box_post_select).change(function(){
            $(resid_furnished_type_box_taxonomy_select).val($(this).val());
        });

        var resid_rent_type_box_taxonomy ='#tagsdiv-property-resid-rent-type';
        var resid_rent_type_box_taxonomy_select = resid_rent_type_box_taxonomy + ' select[name="tax_input[property-resid-rent-type][]"]';
        var resid_rent_type_box_post_select  ='#real_estate_property_resid_rent_type select[name="real_estate_property_resid_rent_type"]';
        $(resid_rent_type_box_taxonomy).css("display", "none");
        $(resid_rent_type_box_taxonomy_select).val($(resid_rent_type_box_post_select).val());
        $(resid_rent_type_box_post_select).change(function(){
            $(resid_rent_type_box_taxonomy_select).val($(this).val());
        });

        var commer_offices_box_taxonomy ='#tagsdiv-property-commer-offices';
        var commer_offices_box_taxonomy_select = commer_offices_box_taxonomy + ' select[name="tax_input[property-commer-offices][]"]';
        var commer_offices_box_post_select  ='#real_estate_property_commer_offices select[name="real_estate_property_commer_offices"]';
        $(commer_offices_box_taxonomy).css("display", "none");
        $(commer_offices_box_taxonomy_select).val($(commer_offices_box_post_select).val());
        $(commer_offices_box_post_select).change(function(){
            $(commer_offices_box_taxonomy_select).val($(this).val());
        });

        var commer_retail_box_taxonomy ='#tagsdiv-property-commer-retail';
        var commer_retail_box_taxonomy_select = commer_retail_box_taxonomy + ' select[name="tax_input[property-commer-retail][]"]';
        var commer_retail_box_post_select  ='#real_estate_property_commer_retail select[name="real_estate_property_commer_retail"]';
        $(commer_retail_box_taxonomy).css("display", "none");
        $(commer_retail_box_taxonomy_select).val($(commer_retail_box_post_select).val());
        $(commer_retail_box_post_select).change(function(){
            $(commer_retail_box_taxonomy_select).val($(this).val());
        });

        var commer_leisure_box_taxonomy ='#tagsdiv-property-commer-leisure';
        var commer_leisure_box_taxonomy_select = commer_leisure_box_taxonomy + ' select[name="tax_input[property-commer-leisure][]"]';
        var commer_leisure_box_post_select  ='#real_estate_property_commer_leisure select[name="real_estate_property_commer_leisure"]';
        $(commer_leisure_box_taxonomy).css("display", "none");
        $(commer_leisure_box_taxonomy_select).val($(commer_leisure_box_post_select).val());
        $(commer_leisure_box_post_select).change(function(){
            $(commer_leisure_box_taxonomy_select).val($(this).val());
        });
        
        var commer_industrial_box_taxonomy ='#tagsdiv-property-commer-industrial';
        var commer_industrial_box_taxonomy_select = commer_industrial_box_taxonomy + ' select[name="tax_input[property-commer-industrial][]"]';
        var commer_industrial_box_post_select  ='#real_estate_property_commer_industrial select[name="real_estate_property_commer_industrial"]';
        $(commer_industrial_box_taxonomy).css("display", "none");
        $(commer_industrial_box_taxonomy_select).val($(commer_industrial_box_post_select).val());
        $(commer_industrial_box_post_select).change(function(){
            $(commer_industrial_box_taxonomy_select).val($(this).val());
        });
        
        var commer_land_box_taxonomy ='#tagsdiv-property-commer-land';
        var commer_land_box_taxonomy_select = commer_land_box_taxonomy + ' select[name="tax_input[property-commer-land][]"]';
        var commer_land_box_post_select  ='#real_estate_property_commer_land select[name="real_estate_property_commer_land"]';
        $(commer_land_box_taxonomy).css("display", "none");
        $(commer_land_box_taxonomy_select).val($(commer_land_box_post_select).val());
        $(commer_land_box_post_select).change(function(){
            $(commer_land_box_taxonomy_select).val($(this).val());
        });

        var commer_other_box_taxonomy ='#tagsdiv-property-commer-other';
        var commer_other_box_taxonomy_select = commer_other_box_taxonomy + ' select[name="tax_input[property-commer-other][]"]';
        var commer_other_box_post_select  ='#real_estate_property_commer_other select[name="real_estate_property_commer_other"]';
        $(commer_other_box_taxonomy).css("display", "none");
        $(commer_other_box_taxonomy_select).val($(commer_other_box_post_select).val());
        $(commer_other_box_post_select).change(function(){
            $(commer_other_box_taxonomy_select).val($(this).val());
        });

        var commer_rent_type_box_taxonomy ='#tagsdiv-property-commer-rent-type';
        var commer_rent_type_box_taxonomy_select = commer_rent_type_box_taxonomy + ' select[name="tax_input[property-commer-rent-type][]"]';
        var commer_rent_type_box_post_select  ='#real_estate_property_commer_rent_type select[name="real_estate_property_commer_rent_type"]';
        $(commer_rent_type_box_taxonomy).css("display", "none");
        $(commer_rent_type_box_taxonomy_select).val($(commer_rent_type_box_post_select).val());
        $(commer_rent_type_box_post_select).change(function(){
            $(commer_rent_type_box_taxonomy_select).val($(this).val());
        });

        var prop_status_box_taxonomy ='#taxonomy-property-status';
        var prop_status_box_taxonomy_checkbox = prop_status_box_taxonomy + ' input[name="tax_input[property-status][]"]';
        var prop_status_box_post_checkbox  ='#real_estate_property_status select[name="real_estate_property_status[]"]';
        $("#property-statusdiv").css("display", "none");
        // $(prop_status_box_taxonomy_checkbox).each(function(){
        //     var checked_initial_array_post = [];
        //     if($.inArray($(this).val(),checked_initial_array_post)!=-1){
        //         $(this).prop("checked",true);
        //     } else {
        //         $(this).prop("checked",false);
        //     }
        // });
        $(prop_status_box_post_checkbox).change(function(){
            var checked_array_post = $(this).val();
            $(prop_status_box_taxonomy_checkbox).each(function(){
                if($.inArray($(this).val(),checked_array_post)!=-1){
                    $(this).prop("checked",true);
                } else {
                    $(this).prop("checked",false);
                }
            });
            property_status_change($(this).val());
        });

        var prop_group_box_post_radio  ='#real_estate_property_group input[name="real_estate_property_group"]';
        var group_val = 0;
        $(prop_group_box_post_radio).change(function(){
            group_val = parseInt($(this).val());
            //property_status_change();
            if (group_val == 0 || group_val == "0") {
                $('#real_estate_property_commer_rent_type').css('display', 'none');
                $('#real_estate_property_resid_rent_type').css('display', '');
            } else if (group_val == 1 || group_val == "1") {
                $('#real_estate_property_commer_rent_type').css('display', '');
                $('#real_estate_property_resid_rent_type').css('display', 'none');
            }
        });

        var property_status_change = function (checked_array_post = []) {
            var forRent = false;
            var forSale = false;
            if (checked_array_post != null && checked_array_post.length > 0) {
                checked_array_post.forEach(function(item) {
                    if ($('#real_estate_property_status div[data-value="' + item + '"]').text().indexOf("For Rent") > -1) {
                        forRent = true;
                    }
                    if ($('#real_estate_property_status div[data-value="' + item + '"]').text().indexOf("For Sale") > -1) {
                        forSale = true;
                    }
                });
            }
            if (forRent == true) {
                if (group_val == 0 || group_val == "0") {
                    $('#real_estate_property_commer_rent_type').css('display', 'none');
                    $('#real_estate_property_resid_rent_type').css('display', '');
                } else if (group_val == 1 || group_val == "1") {
                    $('#real_estate_property_resid_rent_type').css('display', 'none');
                    $('#real_estate_property_commer_rent_type').css('display', '');
                } else {
                    $('#real_estate_property_commer_rent_type').css('display', 'none');
                    $('#real_estate_property_resid_rent_type').css('display', 'none');
                }
                $('#real_estate_property_rent_price').css('display', '');
                $('#real_estate_property_rent_price_auto1').css('display', '');
                $('#real_estate_property_rent_price_auto2').css('display', '');
                $('#real_estate_property_rent_charges').css('display', '');
                $('#real_estate_property_rent_charges_auto1').css('display', '');
                $('#real_estate_property_rent_charges_auto2').css('display', '');
            } else {
                $('#real_estate_property_rent_price').css('display', 'none');
                $('#real_estate_property_rent_price_auto1').css('display', 'none');
                $('#real_estate_property_rent_price_auto2').css('display', 'none');
                $('#real_estate_property_rent_charges').css('display', 'none');
                $('#real_estate_property_rent_charges_auto1').css('display', 'none');
                $('#real_estate_property_rent_charges_auto2').css('display', 'none');
                $('#real_estate_property_resid_rent_type').css('display', 'none');
                $('#real_estate_property_commer_rent_type').css('display', 'none');
            }

            if (forSale == true) {
                $('#real_estate_property_sale_price').css('display', '');
                $('#real_estate_property_sale_price_auto1').css('display', '');
                $('#real_estate_property_sale_price_auto2').css('display', '');                    
            } else {
                $('#real_estate_property_sale_price').css('display', 'none');
                $('#real_estate_property_sale_price_auto1').css('display', 'none');
                $('#real_estate_property_sale_price_auto2').css('display', 'none'); 
            }
        }
        // $(prop_status_box_taxonomy_checkbox).change(function(){
        //     //$(prop_status_box_taxonomy_checkbox).val($(this).val());
        //     var checkedStateValues = $(prop_status_box_taxonomy_checkbox + ':checked').map(function(){
        //         return $(this).val();                    
        //     }).get();
        //     console.log(checkedStateValues);
        // });
        //----------------
        $('input[name="real_estate_additional_feature_title[]"]').css("display", "none");
        $('#real_estate_additional_features .gsf-repeater-header').css("display", "none");
        $('#real_estate_additional_features .gsf-repeater-footer').css("display", "none");
        $('button.gsf-clone-button-add.button.gsf-is-repeater').click(function(){
            $('div[data-input-name="real_estate_additional_feature_title"]').val("feature");
        });        
        //----------------
        $("#property-featurediv").css("display", "block");
        $('div[data-input-name="real_estate_additional_feature_title"]').css("display", "none");
        $('#real_estate_property_commer_other_custom_hidden').css("visibility", "hidden");
        //----------------
        var unit_conversion = function () {
            var fromUnit = $('#real_estate_property_size .gsf-label .gsf-title').text();
            var toUnit = $('#real_estate_property_size_auto .gsf-label .gsf-title').text();
            var unitOriginal = $('#real_estate_property_size input').val();
            var unitConverted = "";
            if (toUnit == "hidden")
                $('#real_estate_property_size_auto').css('display', 'none');
            if (fromUnit == "Size (SqFt)")            
                unitConverted = parseFloat(parseFloat(unitOriginal) / unitsConversionParameter);
            else if (fromUnit == "Size (m2)")            
                unitConverted = parseFloat(parseFloat(unitOriginal) * unitsConversionParameter);
            $('#real_estate_property_size_auto input').val(unitConverted);   
        }
        unit_conversion();
        $('#real_estate_property_size_auto input').prop('disabled', true);
        $('#real_estate_property_size input').change(function(){
            unit_conversion();            
        });
        //----------------
        var get_currency = function (title_value) {
            if (title_value.indexOf("(MKD)") > -1) {
                return 'MKD';
            } else if (title_value.indexOf("(EUR)") > -1) {
                return 'EUR';
            } else if (title_value.indexOf("(USD)") > -1) {
                return 'USD';
            }
            return '';
        }
        var currency_conversion_conditions = function (from_currency, to_currency, original) {
            var eur_to_mkd = $('#real_estate_eur_to_mkd input').val(); //60
            var usd_to_mkd = $('#real_estate_usd_to_mkd input').val(); //50
    
            if (from_currency == 'MKD') {
                if (to_currency == 'USD') {
                    return "approx. " + parseFloat(parseFloat(original) / parseFloat(usd_to_mkd)).toFixed(2);
                } else if (to_currency == 'EUR') {
                    return "approx. " + parseFloat(parseFloat(original) / parseFloat(eur_to_mkd)).toFixed(2);
                }
            } else if (from_currency == 'USD') {
                if (to_currency == 'MKD') {
                    return "approx. " + parseFloat(parseFloat(original) * parseFloat(usd_to_mkd)).toFixed(2);
                } else if (to_currency == 'EUR') {
                    var mkd = parseFloat(parseFloat(original) * parseFloat(usd_to_mkd)); //usd to mkd
                    return "approx. " + parseFloat(parseFloat(mkd) / parseFloat(eur_to_mkd)).toFixed(2);
                }
            } else if (from_currency == 'EUR') {
                if (to_currency == 'MKD') {
                    return "approx. " + parseFloat(parseFloat(original) * parseFloat(eur_to_mkd)).toFixed(2);
                } else if (to_currency == 'USD') {
                    var mkd = parseFloat(parseFloat(original) * parseFloat(eur_to_mkd));
                    return "approx. " + parseFloat(parseFloat(mkd) / parseFloat(usd_to_mkd)).toFixed(2);
                }
            }
            return original;
        }
        var currency_conversion = function (field = '') {
            if (field == '' || field == 'real_estate_property_rent_price') {
                var from_curr_property_rent_price = get_currency($('#real_estate_property_rent_price .gsf-label .gsf-title').text());
                var to_curr_property_rent_price_auto1 = get_currency($('#real_estate_property_rent_price_auto1 .gsf-label .gsf-title').text());
                var to_curr_property_rent_price_auto2 = get_currency($('#real_estate_property_rent_price_auto2 .gsf-label .gsf-title').text());
                var property_rent_price = $('input[name="real_estate_property_rent_price"]').val();
                $('input[name="real_estate_property_rent_price_auto1"]').val(currency_conversion_conditions(from_curr_property_rent_price, to_curr_property_rent_price_auto1, property_rent_price));
                $('input[name="real_estate_property_rent_price_auto2"]').val(currency_conversion_conditions(from_curr_property_rent_price, to_curr_property_rent_price_auto2, property_rent_price));
            }
            if (field == '' || field == 'real_estate_property_rent_charges') {
                var from_curr_property_rent_charges = get_currency($('#real_estate_property_rent_charges .gsf-label .gsf-title').text());
                var to_curr_property_rent_charges_auto1 = get_currency($('#real_estate_property_rent_charges_auto1 .gsf-label .gsf-title').text());
                var to_curr_property_rent_charges_auto2 = get_currency($('#real_estate_property_rent_charges_auto2 .gsf-label .gsf-title').text());
                var property_rent_charges = $('input[name="real_estate_property_rent_charges"]').val();
                $('input[name="real_estate_property_rent_charges_auto1"]').val(currency_conversion_conditions(from_curr_property_rent_charges, to_curr_property_rent_charges_auto1, property_rent_charges));
                $('input[name="real_estate_property_rent_charges_auto2"]').val(currency_conversion_conditions(from_curr_property_rent_charges, to_curr_property_rent_charges_auto2, property_rent_charges));
            }
            if (field == '' || field == 'real_estate_property_sale_price') {
                var from_curr_property_sale_price = get_currency($('#real_estate_property_sale_price .gsf-label .gsf-title').text());
                var to_curr_property_sale_price_auto1 = get_currency($('#real_estate_property_sale_price_auto1 .gsf-label .gsf-title').text());
                var to_curr_property_sale_price_auto2 = get_currency($('#real_estate_property_sale_price_auto2 .gsf-label .gsf-title').text());
                var property_sale_price = $('input[name="real_estate_property_sale_price"]').val();
                $('input[name="real_estate_property_sale_price_auto1"]').val(currency_conversion_conditions(from_curr_property_sale_price, to_curr_property_sale_price_auto1, property_sale_price));
                $('input[name="real_estate_property_sale_price_auto2"]').val(currency_conversion_conditions(from_curr_property_sale_price, to_curr_property_sale_price_auto2, property_sale_price));
            }        
        }
        currency_conversion();
        $('input[name="real_estate_property_rent_price"]').change(function(){
            currency_conversion('real_estate_property_rent_price');
        });
        $('input[name="real_estate_property_rent_charges"]').change(function(){
            currency_conversion('real_estate_property_rent_charges');
        });
        $('input[name="real_estate_property_sale_price"]').change(function(){
            currency_conversion('real_estate_property_sale_price');
        });

        $('#real_estate_eur_to_mkd').css('display', 'none');//.css('visibility', 'hidden');//
        $('#real_estate_usd_to_mkd').css('display', 'none');//.css('visibility', 'hidden');//
        $('#real_estate_property_rent_price_auto1 input').prop('disabled', true);
        $('#real_estate_property_rent_price_auto2 input').prop('disabled', true);
        $('#real_estate_property_rent_charges_auto1 input').prop('disabled', true);
        $('#real_estate_property_rent_charges_auto2 input').prop('disabled', true); 
        $('#real_estate_property_sale_price_auto1 input').prop('disabled', true);
        $('#real_estate_property_sale_price_auto2 input').prop('disabled', true);        
        //----------------
        var css_class_wrap = '.ere-property-select-meta-box-wrap';
        var ajax_url = ere_admin_vars.ajax_url;
        var enable_filter_location=ere_admin_vars.enable_filter_location;
        if(enable_filter_location=='1')
        {
            $('.ere-property-country-ajax', css_class_wrap).select2();
            $('.ere-property-state-ajax', css_class_wrap).select2();
            $('.ere-property-city-ajax', css_class_wrap).select2();
            $('.ere-property-neighborhood-ajax', css_class_wrap).select2();
        }

        var ere_get_states_by_country = function () {
            var $this = $(".ere-property-country-ajax", css_class_wrap);
            var $property_state = $(".ere-property-state-ajax", css_class_wrap);
            var $is_slug = $property_state.attr('data-slug');
            if (typeof($is_slug) === 'undefined') {
                $is_slug='1';
            }
            if ($this.length && $property_state.length) {
                var selected_country = $this.val();
                $.ajax({
                    type: "POST",
                    url: ajax_url,
                    data: {
                        'action': 'ere_get_states_by_country_ajax',
                        'country': selected_country,
                        'type': 0,
                        'is_slug':$is_slug
                    },
                    beforeSend: function () {
                        $this.parent().children('.ere-loading').remove();
                        $this.parent().append('<span class="ere-loading"><i class="fa fa-spinner fa-spin"></i></span>');
                    },
                    success: function (response) {
                        $property_state.html(response);
                        var val_selected =$property_state.attr('data-selected');
                        if (typeof val_selected !== 'undefined') {
                            $property_state.val(val_selected);
                        }
                        $this.parent().children('.ere-loading').remove();
                    },
                    error: function () {
                        $this.parent().children('.ere-loading').remove();
                    },
                    complete: function () {
                        $this.parent().children('.ere-loading').remove();
                    }
                });
            }
        };
        ere_get_states_by_country();

        $(".ere-property-country-ajax", css_class_wrap).on('change', function () {
            ere_get_states_by_country();
        });

        var ere_get_cities_by_state = function () {
            var $this = $(".ere-property-state-ajax", css_class_wrap);
            var $property_city = $(".ere-property-city-ajax", css_class_wrap);
            var $is_slug = $property_city.attr('data-slug');
            if (typeof($is_slug) === 'undefined') {
                $is_slug='1';
            }
            if ($this.length && $property_city.length) {
                var selected_state = $this.val();
                $.ajax({
                    type: "POST",
                    url: ajax_url,
                    data: {
                        'action': 'ere_get_cities_by_state_ajax',
                        'state': selected_state,
                        'type': 0,
                        'is_slug':$is_slug
                    },
                    beforeSend: function () {
                        $this.parent().children('.ere-loading').remove();
                        $this.parent().append('<span class="ere-loading"><i class="fa fa-spinner fa-spin"></i></span>');
                    },
                    success: function (response) {
                        $property_city.html(response);
                        var val_selected = $property_city.attr('data-selected');
                        if (typeof val_selected !== 'undefined') {
                            $property_city.val(val_selected);
                        }
                        $this.parent().children('.ere-loading').remove();
                    },
                    error: function () {
                        $this.parent().children('.ere-loading').remove();
                    },
                    complete: function () {
                        $this.parent().children('.ere-loading').remove();
                    }
                });
            }
        };
        ere_get_cities_by_state();

        $(".ere-property-state-ajax", css_class_wrap).on('change', function () {
            ere_get_cities_by_state();
        });

        var ere_get_neighborhoods_by_city = function () {
            var $this = $(".ere-property-city-ajax", css_class_wrap);
            var $property_neighborhood = $(".ere-property-neighborhood-ajax", css_class_wrap);
            var $is_slug = $property_neighborhood.attr('data-slug');
            if (typeof($is_slug) === 'undefined') {
                $is_slug='1';
            }
            if ($this.length && $property_neighborhood.length) {
                var selected_city = $this.val();
                $.ajax({
                    type: "POST",
                    url: ajax_url,
                    data: {
                        'action': 'ere_get_neighborhoods_by_city_ajax',
                        'city': selected_city,
                        'type': 0,
                        'is_slug':$is_slug
                    },
                    beforeSend: function () {
                        $this.parent().children('.ere-loading').remove();
                        $this.parent().append('<span class="ere-loading"><i class="fa fa-spinner fa-spin"></i></span>');
                    },
                    success: function (response) {
                        $property_neighborhood.html(response);
                        var val_selected = $property_neighborhood.attr('data-selected');
                        if (typeof val_selected !== 'undefined') {
                            $property_neighborhood.val(val_selected);
                        }
                        $this.parent().children('.ere-loading').remove();
                    },
                    error: function () {
                        $this.parent().children('.ere-loading').remove();
                    },
                    complete: function () {
                        $this.parent().children('.ere-loading').remove();
                    }
                });
            }
        };
        ere_get_neighborhoods_by_city();

        $(".ere-property-city-ajax", css_class_wrap).on('change', function () {
            ere_get_neighborhoods_by_city();
        });
    });
})(jQuery);